# =============================================================================
# Docker Compose for Ladybug-RS Local Development
# =============================================================================
#
# Usage:
#   docker-compose up              # Start with default settings
#   docker-compose up --build      # Rebuild and start
#   docker-compose up -d           # Start in background
#   docker-compose logs -f         # Follow logs
#   docker-compose down            # Stop and remove
#
# Profiles:
#   docker-compose --profile avx512 up    # Use AVX-512 optimized build
#   docker-compose --profile dev up       # Development with hot reload
#   docker-compose --profile n8n up       # Ladybug + n8n workflow engine
#   docker-compose --profile crewai up    # Ladybug + crewAI orchestration
#   docker-compose --profile full up      # Ladybug + n8n + crewAI
# =============================================================================

version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # Main Ladybug-RS Server (auto-detect CPU features)
  # ---------------------------------------------------------------------------
  ladybug:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_CPU: native
        FEATURES: "simd,parallel,codebook,hologram,quantum"
    container_name: ladybug-rs
    ports:
      - "8080:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ---------------------------------------------------------------------------
  # AVX-512 Optimized (for Railway/modern servers)
  # ---------------------------------------------------------------------------
  ladybug-avx512:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime-avx512
    container_name: ladybug-rs-avx512
    profiles:
      - avx512
    ports:
      - "8080:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Development mode (mount source for iteration)
  # ---------------------------------------------------------------------------
  ladybug-dev:
    image: rust:1.75-bookworm
    container_name: ladybug-rs-dev
    profiles:
      - dev
    working_dir: /app
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    ports:
      - "8080:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - RUST_LOG=debug
      - CARGO_TARGET_DIR=/app/target
    command: >
      bash -c "
        cargo build --release --bin ladybug-server --features 'simd,parallel,codebook,hologram,quantum' &&
        ./target/release/ladybug-server
      "
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Ladybug + n8n workflow engine
  # ---------------------------------------------------------------------------
  ladybug-n8n:
    build:
      context: .
      dockerfile: Dockerfile.n8n
    container_name: ladybug-rs-n8n
    profiles:
      - n8n
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - LADYBUG_HOST=0.0.0.0
      - LADYBUG_PORT=8080
      - LADYBUG_FLIGHT_PORT=50051
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ---------------------------------------------------------------------------
  # Ladybug + crewAI agent orchestration
  # ---------------------------------------------------------------------------
  ladybug-crewai:
    build:
      context: .
      dockerfile: Dockerfile.crewai
    container_name: ladybug-rs-crewai
    profiles:
      - crewai
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - LADYBUG_HOST=0.0.0.0
      - LADYBUG_PORT=8080
      - LADYBUG_FLIGHT_PORT=50051
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ---------------------------------------------------------------------------
  # Ladybug + n8n + crewAI (full vendor build)
  # ---------------------------------------------------------------------------
  ladybug-full:
    build:
      context: .
      dockerfile: Dockerfile.full
    container_name: ladybug-rs-full
    profiles:
      - full
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - LADYBUG_HOST=0.0.0.0
      - LADYBUG_PORT=8080
      - LADYBUG_FLIGHT_PORT=50051
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # ---------------------------------------------------------------------------
  # Unified â€” ONE Docker, ONE Port, THREE Engines (Railway-ready)
  # ---------------------------------------------------------------------------
  # Usage:
  #   docker-compose --profile unified up --build
  #   curl -X POST http://localhost:8080/cmd -d "PING"
  #   curl -X POST http://localhost:8080/cmd -d "HELP"
  #   curl -X POST http://localhost:8080/cmd -d 'CREW.STATUS'
  #   curl -X POST http://localhost:8080/cmd -d 'WF.LIST'
  #   curl -X POST http://localhost:8080/cmd -d 'SQL SELECT 1'
  # ---------------------------------------------------------------------------
  ladybug-unified:
    build:
      context: .
      dockerfile: Dockerfile.unified
    container_name: ladybug-unified
    profiles:
      - unified
    ports:
      - "8080:8080"
    environment:
      - LADYBUG_HOST=0.0.0.0
      - LADYBUG_PORT=8080
      - CREWAI_PORT=8090
      - N8N_PORT=8091
      - CREWAI_URL=http://127.0.0.1:8090
      - N8N_URL=http://127.0.0.1:8091
      - LADYBUG_DATA_DIR=/data
      - RUST_LOG=info
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

volumes:
  cargo-cache:
  target-cache:

networks:
  default:
    name: ladybug-network
